name: Deploy Frontend

on:
  workflow_dispatch:  # 수동 실행 전용
    inputs:
      target:
        type: choice
        description: "배포 환경 선택"
        options:
          - dev
          - prod
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1) 소스 체크아웃
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      # -----------------------------
      # 2) Node.js 설치
      # -----------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      # -----------------------------
      # 3) Next.js 빌드
      # -----------------------------
      - name: Install dependencies & Build
        run: |
          npm ci
          npm run build

      # -----------------------------
      # 4) gcloud 설치 & 서비스 계정 인증
      # -----------------------------
      - name: Install gcloud
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.TEST_GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.TEST_GCP_SA_KEY }}
          export_default_credentials: true

      # -----------------------------
      # 5) rsync + IAP SSH로 파일 업로드
      # -----------------------------
      - name: Upload files to frontend VM
        run: |
          # VM IAP SSH용 임시 SSH 구성 가져오기
          IAP_SSH=$(gcloud compute ssh ${{ secrets.TEST_GCP_VM_NAME }} \
            --zone=${{ secrets.TEST_GCP_ZONE }} \
            --tunnel-through-iap \
            --dry-run \
            2>&1 | grep "^ssh")

          echo "Detected SSH command: $IAP_SSH"

          # rsync 실행
          rsync -avz --delete -e "$IAP_SSH" \
            . ${{ secrets.TEST_GCP_PATH }}

      # -----------------------------
      # 6) VM 내부에서 PM2로 프론트 재시작
      # -----------------------------
      - name: Restart frontend service on VM
        run: |
          gcloud compute ssh ${{ secrets.TEST_GCP_VM_NAME }} \
            --zone=${{ secrets.TEST_GCP_ZONE }} \
            --tunnel-through-iap \
            --command="cd ${{ secrets.TEST_GCP_PATH }} && npm ci --production && pm2 restart frontend || pm2 start npm --name frontend -- start && pm2 save"
