name: Deploy woojung front

on:
  workflow_dispatch:
    inputs:
      target:
        type: choice
        description: "배포 환경 선택"
        options:
          - dev
          - prod
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js
        run: npm run build

      - name: Set environment variables based on input
        id: envselect
        run: |
          echo "선택된 환경: ${{ github.event.inputs.target }}"

          if [ "${{ github.event.inputs.target }}" = "dev" ]; then
            echo "HOST=${{ secrets.DEV_VM_HOST }}" >> $GITHUB_ENV
            echo "USER=${{ secrets.DEV_VM_USER }}" >> $GITHUB_ENV
            echo "PATH_DIR=${{ secrets.DEV_VM_PATH }}" >> $GITHUB_ENV
            echo "${{ secrets.DEV_VM_SSH_KEY }}" > key.pem
          else
            echo "HOST=${{ secrets.PRD_VM_HOST }}" >> $GITHUB_ENV
            echo "USER=${{ secrets.PRD_VM_USER }}" >> $GITHUB_ENV
            echo "PATH_DIR=${{ secrets.PRD_VM_PATH }}" >> $GITHUB_ENV
            echo "${{ secrets.PRD_VM_SSH_KEY }}" > key.pem
          fi

          chmod 600 key.pem

      - name: Setup SSH known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H $HOST >> ~/.ssh/known_hosts

      - name: Upload files to VM
        run: |
          rsync -avz --delete \
            -e "ssh -i key.pem" \
            --exclude='.git' \
            --exclude='node_modules' \
            . $USER@$HOST:$PATH_DIR

      - name: Restart PM2 Service
        run: |
          ssh -i key.pem $USER@$HOST << 'EOF'
            cd $PATH_DIR
            npm ci --production
            pm2 restart nextjs-app || pm2 start npm --name "nextjs-app" -- start
            pm2 save
          EOF
